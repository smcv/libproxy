diff -Nur -x '*.orig' -x '*~' libproxy-0.2.3/src/lib/proxy_factory.c libproxy-0.2.3.new/src/lib/proxy_factory.c
--- libproxy-0.2.3/src/lib/proxy_factory.c	2008-06-05 22:56:15.000000000 +0200
+++ libproxy-0.2.3.new/src/lib/proxy_factory.c	2009-01-08 11:33:28.000000000 +0100
@@ -514,6 +514,8 @@
 	pxConfig *config   = NULL;
 	char    **response = px_strsplit("direct://", ";");
 	char     *tmp = NULL, *order = NULL, **orderv = NULL;
+	char     *wpad_fallback_env = NULL;
+	int       do_wpad_fallback = 0;         // default to not fall back
 	
 	// Verify some basic stuff
 	if (!self)                    goto do_return;
@@ -581,9 +583,27 @@
 	for (int i=0 ; self->configs && self->configs[i] && !config ; i++)
 		config = self->configs[i]->callback(self);
 	
+	// check PX_WPAD_FALLBACK env var for an override for the WPAD fall
+	// back mechanism
+	wpad_fallback_env = getenv("PX_WPAD_FALLBACK");
+	if (wpad_fallback_env)
+	{
+		if (!strcmp(wpad_fallback_env, "0")) {
+			do_wpad_fallback = 0;
+		} else if (!strcmp(wpad_fallback_env, "0")) {
+			do_wpad_fallback = 1;
+		}
+	}
+	px_free(wpad_fallback_env);
+
 	// No plugin returned a valid config, fall back to 'wpad://'
 	if (!config)
 	{
+		if (!do_wpad_fallback)
+		{
+			fprintf(stderr, "*** Unable to locate valid config and WPAD fallback disabled! Falling back to direct...\n");
+			goto do_return;
+		}
 		fprintf(stderr, "*** Unable to locate valid config! Falling back to auto-detection...\n");
 		config         = px_malloc0(sizeof(pxConfig));
 		config->url    = px_strdup("wpad://");
@@ -597,6 +617,11 @@
 		  !strcmp (config->url, "wpad://") ||
 		  !strcmp (config->url, "direct://")))
 	{
+		if (!do_wpad_fallback)
+		{
+			fprintf(stderr, "*** Config plugin returned invalid URL type and WPAD fallback disabled! Falling back to direct...\n");
+			goto do_return;
+		}
 		fprintf(stderr, "*** Config plugin returned invalid URL type! Falling back to auto-detection...\n");
 		px_free(config->url);
 		config->url = px_strdup("wpad://");
